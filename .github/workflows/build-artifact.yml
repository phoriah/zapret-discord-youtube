name: Zapret Auto Builder

on:
  workflow_dispatch:
    inputs:
      auto_commit:
        description: '–ê–≤—Ç–æ-–∫–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  
  push:
    branches: [ main ]
    paths-ignore:
      - 'bin/**'
      - 'lists/ipset-all.txt'
      - '.github/workflows/*'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: ‚¨áÔ∏è Clone source repo
        run: |
          mkdir -p zapret-build
          cd zapret-build
          
          git clone --depth 1 --filter=tree:0 \
            --sparse https://github.com/Flowseal/zapret-discord-youtube.git source
          
          cd source
          git sparse-checkout set --no-cone '*' '!.github'
          git checkout main
          
          echo "‚úÖ Source cloned ($(find . -type f | wc -l) files)"
          

      - name: üîÑ Sync binaries (bol-van)
        run: |
          cd zapret-build/source
          
          if [ -d "bin" ]; then
            echo "üîß Updating binaries..."
            
            # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            files=()
            for f in bin/*; do
              [ -f "$f" ] && files+=("$(basename "$f")")
            done
            
            updated=0
            for file in "${files[@]}"; do
              url="https://github.com/bol-van/zapret-win-bundle/raw/master/zapret-winws/$file"
              
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º wget –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
              if wget --spider --quiet "$url" 2>/dev/null || true; then
                echo "  üì• $file"
                wget -q -O "bin/$file" "$url" &
                ((updated++))
                echo "  X $file"
              else
                echo "  ‚è≠Ô∏è  $file (not in bol-van)"
              fi
            done
            
            # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
            wait
            echo "‚úÖ Updated $updated binaries"
          fi

      - name: üêç Run AS Parser (V3nilla)
        run: |
          cd /tmp
          # –°–∫–∞—á–∏–≤–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–µ—Ä
          curl -L -o AS_Parser.py https://raw.githubusercontent.com/V3nilla/IPSets-For-Bypass-in-Russia/main/AS%20Parser/AS_Parser.py
          echo "‚ö° Generating IPset..."
          start_time=$(date +%s)
          python3 AS_Parser.py
          end_time=$(date +%s)
          
          if [ -f "all_prefixes_aggregated.txt" ]; then
            mv all_prefixes_aggregated.txt $GITHUB_WORKSPACE/zapret-build/source/lists/ipset-all.txt
            echo "‚úÖ IPset: $(wc -l < all_prefixes_aggregated.txt) prefixes ($((end_time - start_time))s)"
          else
            echo "‚ùå Parser did not create output file!"
            exit 1
          fi

      - name: üì¶ Package final build
        run: |
          cd zapret-build
          
          mkdir -p final
          cp -a source/. final/
          rm -rf final/.git

          build_date=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          artifact_url="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –æ—Ç—á–µ—Ç –æ —Å–±–æ—Ä–∫–µ
          echo "Auto Build completed: $build_date" > final/build_info.txt
          echo "Artifact: $artifact_url" >> final/build_info.txt
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
          echo "=== Final structure ==="
          find final -type f | sort

      - name: üì§ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zapret-${{ github.run_number }}-$(date +%Y%m%d-%H%M)
          path: zapret-build/final/
          if-no-files-found: error

      - name: üíæ Auto-commit (optional)
        if: |
          github.event_name == 'workflow_dispatch' &&
          inputs.auto_commit == 'true'
        run: |
          cd zapret-build/source
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add bin/ lists/ipset-all.txt 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No changes to commit"
          else
            git commit -m "Auto-update: binaries and IPset [$GITHUB_RUN_NUMBER]
            
            ‚Ä¢ Updated ${UPDATED_BINARIES:-0} binaries
            ‚Ä¢ IPset: ${IPSET_LINES:-0} prefixes
            ‚Ä¢ Build: $GITHUB_RUN_ID
            ‚Ä¢ Source: $SOURCE_COMMIT
            
            [skip ci]"
            
            git push
            echo "‚úÖ Changes committed"
          fi
